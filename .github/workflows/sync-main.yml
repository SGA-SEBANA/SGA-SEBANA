name: Check developer branches against main (notify only)

on:
  push:
    branches:
      - main

jobs:
  check-branches:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        include:
          - branch: julian-clot
            user: JulianClotCordoba
          - branch: jorge-castillo
            user: JorgeLuisCastrilloMolina
          - branch: joel-peralta
            user: joeljperalta
          - branch: derlis-hernandez
            user: derlisbach-lang

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ðŸ” Verificar si el branch estÃ¡ detrÃ¡s de main
      - name: Check if ${{ matrix.branch }} is behind main
        id: check
        run: |
          git fetch origin

          BEHIND=$(git rev-list --count origin/${{ matrix.branch }}..origin/main)

          echo "behind=$BEHIND" >> $GITHUB_OUTPUT

          if [ "$BEHIND" -gt 0 ]; then
            echo "Branch is behind main"
            exit 1
          else
            echo "Branch is up to date"
          fi
        continue-on-error: true

      # âŒ Crear issue si el branch estÃ¡ desfasado
      - name: Create issue if branch is behind
        if: steps.check.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const branch = "${{ matrix.branch }}";
            const user = "${{ matrix.user }}";
            const title = `âŒ ${branch} estÃ¡ desfasado respecto a main`;

            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: "open"
            });

            const existing = issues.data.find(i => i.title === title);

            if (!existing) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                assignees: [user],
                labels: ["conflict", "ci"],
                body: `
@${user}

Tu branch **\`${branch}\` no estÃ¡ sincronizado con \`main\`**.

ðŸ”§ **CÃ³mo arreglarlo (FORMA CORRECTA):**
\`\`\`bash
git checkout ${branch}
git fetch origin
git rebase origin/main
git push --force-with-lease
\`\`\`

â— No uses \`git pull origin main\`  
â— No hagas merge de \`main\` dentro del branch

Commit que disparÃ³ el check:
${context.sha}
`
              });
            }

      # âœ… Cerrar issue cuando el branch ya estÃ© al dÃ­a
      - name: Close issue when branch is up to date
        if: steps.check.outcome == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            const branch = "${{ matrix.branch }}";
            const title = `âŒ ${branch} estÃ¡ desfasado respecto a main`;

            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: "open"
            });

            const existing = issues.data.find(i => i.title === title);

            if (existing) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existing.number,
                state: "closed"
              });
            }
