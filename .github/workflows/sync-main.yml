name: PR branch must be up to date with main

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  check-pr-branch:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if PR branch is behind main
        id: check
        run: |
          git fetch origin

          BASE=origin/main
          HEAD=origin/${{ github.head_ref }}

          BEHIND=$(git rev-list --count ${HEAD}..${BASE})

          echo "behind=$BEHIND" >> $GITHUB_OUTPUT

          if [ "$BEHIND" -gt 0 ]; then
            echo "âŒ Branch is behind main"
            exit 1
          else
            echo "âœ… Branch is up to date with main"
          fi

      # âŒ Crear issue si el PR estÃ¡ detrÃ¡s de main
      - name: Create issue if PR is behind main
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const branch = context.payload.pull_request.head.ref;
            const user = context.payload.pull_request.user.login;
            const pr = context.payload.pull_request.number;

            const title = `âŒ PR #${pr} (${branch}) estÃ¡ desfasado respecto a main`;

            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: "open"
            });

            const existing = issues.data.find(i => i.title === title);

            if (!existing) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                assignees: [user],
                labels: ["conflict", "ci"],
                body: `
@${user}

Tu Pull Request **#${pr}** estÃ¡ basado en un \`main\` desactualizado.

ðŸ”§ **CÃ³mo solucionarlo (FORMA CORRECTA):**
\`\`\`bash
git checkout ${branch}
git fetch origin
git rebase origin/main
git push --force-with-lease
\`\`\`

â— No uses \`git pull origin main\`  
â— No hagas merge de \`main\` dentro del branch

Cuando actualices el PR, este issue se cerrarÃ¡ automÃ¡ticamente.
`
              });
            }

      # âœ… Cerrar issue cuando el PR ya estÃ© actualizado
      - name: Close issue when PR is up to date
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const branch = context.payload.pull_request.head.ref;
            const pr = context.payload.pull_request.number;

            const title = `âŒ PR #${pr} (${branch}) estÃ¡ desfasado respecto a main`;

            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: "open"
            });

            const existing = issues.data.find(i => i.title === title);

            if (existing) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existing.number,
                state: "closed"
              });
            }
